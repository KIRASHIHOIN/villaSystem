<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.coding.villaSystem.mapper.PermissionMapper">
    <resultMap id="fatherAndChild" type="com.coding.villaSystem.entity.Permission">
        <id column="permission_father_id" property="permissionId"></id>
        <result column="permission_father_name" property="permissionName"></result>
        <result column="permission_father_describe" property="permissionDescribe"></result>
        <collection property="childPermission" ofType="com.coding.villaSystem.entity.Permission">
            <id column="permission_child_id" property="permissionId"></id>
            <result column="permission_child_name" property="permissionName"></result>
            <result column="permission_child_describe" property="permissionDescribe"></result>
            <result column="permission_child_path" property="permissionPath"></result>
        </collection>
    </resultMap>

    <resultMap id="childAndFather" type="com.coding.villaSystem.entity.Permission">
        <id column="permission_child_id" property="permissionId"></id>
        <result column="permission_child_name" property="permissionName"></result>
        <result column="permission_child_describe" property="permissionDescribe"></result>
        <result column="permission_child_path" property="permissionPath"></result>
        <result column="permission_child_addtime" property="permissionAddtime"></result>
        <association property="fatherPermission" javaType="com.coding.villaSystem.entity.Permission">
            <id column="permission_father_id" property="permissionId"></id>
            <result column="permission_father_name" property="permissionName"></result>
            <result column="permission_father_describe" property="permissionDescribe"></result>
        </association>
    </resultMap>

    <select id="selectPermissionByActorId" resultMap="fatherAndChild">
        SELECT father.permission_id       AS permission_father_id,
               father.permission_name     AS permission_father_name,
               father.permission_describe AS permission_father_describe,
               child.permission_id        AS permission_child_id,
               child.permission_name      AS permission_child_name,
               child.permission_describe  AS permission_child_describe,
               child.permission_path      AS permission_child_path
        FROM permission AS father
                 JOIN permission AS child
                      ON child.permission_father_id = father.permission_id
                 JOIN actorpermission
                      ON actorpermission.permission_id = child.permission_id
        WHERE actorpermission.actor_id = #{actorId}
    </select>

    <select id="selectPermissionByCondition" resultMap="childAndFather">
        SELECT child.permission_id AS permission_child_id,
        child.permission_name AS permission_child_name,
        child.permission_describe AS permission_child_describe,
        child.permission_path AS permission_child_path,
        child.permission_addtime AS permission_child_addtime,
        father.permission_id AS permission_father_id,
        father.permission_name AS permission_father_name,
        father.permission_describe AS permission_father_describe
        FROM permission AS child
        LEFT JOIN permission AS father
        ON child.permission_father_id = father.permission_id
        <where>
            <if test="condition != null and condition != ''">
                (
                child.permission_id LIKE CONCAT('%',#{condition},'%')
                OR
                child.permission_name LIKE CONCAT('%',#{condition},'%')
                OR
                child.permission_describe LIKE CONCAT('%',#{condition},'%')
                )
            </if>
            <if test="permissionFatherId != null and permissionFatherId >= 0">
                AND child.permission_father_id = #{permissionFatherId}
            </if>
        </where>
        ORDER BY child.permission_addtime DESC
    </select>
    <select id="selectFatherPermission" resultType="com.coding.villaSystem.entity.Permission">
        SELECT permission_id,
               permission_name,
               permission_describe,
               permission_path,
               permission_addtime
        FROM permission
        WHERE permission_father_id = ""
           OR permission_father_id IS NULL
    </select>

    <select id="selectAllPermission" resultMap="fatherAndChild">
        SELECT father.permission_id       AS permission_father_id,
               father.permission_name     AS permission_father_name,
               father.permission_describe AS permission_father_describe,
               child.permission_id        AS permission_child_id,
               child.permission_name      AS permission_child_name,
               child.permission_describe  AS permission_child_describe,
               child.permission_path      AS permission_child_path
        FROM permission AS father
                 JOIN permission AS child
                      ON child.permission_father_id = father.permission_id
    </select>
    <insert id="insertPermission" parameterType="com.coding.villaSystem.entity.Permission">
        INSERT INTO permission (permission_name, permission_describe, permission_path, permission_father_id)
        VALUES (#{permissionName}, #{permissionDescribe}, #{permissionPath}, #{permissionFatherId})
    </insert>
    <update id="updatePermission" parameterType="com.coding.villaSystem.entity.Permission">
        UPDATE permission
        SET permission_name      = #{permissionName},
            permission_describe  = #{permissionDescribe},
            permission_path      = #{permissionPath},
            permission_father_id = #{permissionFatherId}
        WHERE permission_id = #{permissionId}
    </update>
    <select id="selectPermissionById" resultType="com.coding.villaSystem.entity.Permission">
        SELECT permission_id,
               permission_name,
               permission_describe,
               permission_path,
               permission_father_id
        FROM permission
        WHERE permission_id = #{permissionId}
    </select>
    <delete id="deletePermissionById" parameterType="com.coding.villaSystem.entity.Permission">
        DELETE
        FROM permission
        WHERE permission_id = #{permissionId}
    </delete>
</mapper>